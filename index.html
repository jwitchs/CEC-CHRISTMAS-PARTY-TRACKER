import React, { useState } from 'react';
import { Download, CheckCircle, XCircle, Search, UserCheck, Users } from 'lucide-react';

const initialParticipants = [
  "Clarabelle Dejanio", "Jocelyn Monton", "Ken Chua", "Kent Jacob", "Erica Yed Tumulak",
  "Ysa Tepait", "Samuel Colimbo", "Corrine Carmelle", "Ericka Salas", "Myka Marigomen",
  "Princess Mendiola", "Beverly Montebon", "Arianne Marquez", "Deion Alfred Encarguez", "Derek Punes",
  "Carmela Tio Go", "Eunice Pangilinan", "Bianca LapiÃ±a", "Reevey Ilao Gonzales", "Hezekiah MondoÃ±edo",
  "Charles Benedict Tecson Origenes", "Leigh T. Heyrana", "John Russel Jandonero", "Paul Mangubat", "Vince Nathan Mataragnon",
  "Zach Jullian Atupan", "Dave Unabia", "Mikay Ponce", "MC Lawrence", "Jethro Ismael Pamisa Tamala",
  "Margarethe Allanaraiz", "Clark Calacar", "Arianna Ruth Gabunada", "Jon Gil Azcarraga Ramas", "Sophia Abyy",
  "Ma Alexie Aguilar", "Jacob Malazarte", "Maverick Gabrielle", "Amiel Zachary Embrace", "Jamboy Gonzalo",
  "Ma Kate John Borgonia", "Bea Uy", "Elijah Espadilla", "Isaiah David", "Sophia Nandini",
  "Raymond Tabuelog Magdalan", "Marlon Ociel", "Michael Cebrian", "Ashley Britz Chua", "Adrian James Yap",
  "Silvien Libatan"
].map((name, index) => ({ id: index, name, paid: false }));

export default function App() {
  const [participants, setParticipants] = useState(initialParticipants);
  const [searchTerm, setSearchTerm] = useState("");

  const togglePaid = (id) => {
    setParticipants(prev => prev.map(p => 
      p.id === id ? { ...p, paid: !p.paid } : p
    ));
  };

  const markAll = (status) => {
    if (confirm(`Are you sure you want to mark all filtered users as ${status ? 'PAID' : 'UNPAID'}?`)) {
       setParticipants(prev => prev.map(p => {
         // Only affect currently visible/filtered items if search is active
         if (p.name.toLowerCase().includes(searchTerm.toLowerCase())) {
            return { ...p, paid: status };
         }
         return p;
       }));
    }
  };

  const exportToCSV = () => {
    // CSV Header
    const headers = ["Name", "Payment Status"];
    
    // Map data to CSV rows
    const rows = participants.map(p => [
      `"${p.name}"`, // Quote names to handle commas if any
      p.paid ? "Paid" : "Not Paid"
    ]);

    // Combine headers and rows
    const csvContent = [
      headers.join(","), 
      ...rows.map(row => row.join(","))
    ].join("\n");

    // Create a Blob and download link
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", "CEC_Christmas_Party_Payments.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // Derived state
  const filteredParticipants = participants.filter(p => 
    p.name.toLowerCase().includes(searchTerm.toLowerCase())
  );
  
  const totalPaid = participants.filter(p => p.paid).length;
  const totalCount = participants.length;
  const progress = (totalPaid / totalCount) * 100;

  return (
    <div className="min-h-screen bg-gray-50 p-4 sm:p-8 font-sans text-gray-800">
      <div className="max-w-4xl mx-auto bg-white shadow-xl rounded-xl overflow-hidden border border-gray-100">
        
        {/* Header Section */}
        <div className="bg-gradient-to-r from-red-600 to-green-700 p-6 text-white">
          <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
              <h1 className="text-2xl md:text-3xl font-bold flex items-center gap-2">
                ðŸŽ„ CEC Christmas Party
              </h1>
              <p className="text-red-100 mt-1 opacity-90">Payment Tracker & Attendance</p>
            </div>
            <button 
              onClick={exportToCSV}
              className="bg-white text-green-700 hover:bg-gray-100 px-4 py-2 rounded-lg font-semibold shadow-sm flex items-center gap-2 transition-all active:scale-95"
            >
              <Download size={18} />
              Export to Excel/CSV
            </button>
          </div>

          {/* Stats Bar */}
          <div className="mt-6 bg-black/20 rounded-lg p-4 flex flex-wrap gap-6 items-center">
            <div className="flex items-center gap-3">
              <div className="bg-white/20 p-2 rounded-full">
                <Users size={20} className="text-white" />
              </div>
              <div>
                <p className="text-xs text-gray-200 uppercase tracking-wider font-semibold">Total Guests</p>
                <p className="text-xl font-bold">{totalCount}</p>
              </div>
            </div>
            
            <div className="flex items-center gap-3">
              <div className="bg-green-500/30 p-2 rounded-full">
                <CheckCircle size={20} className="text-green-300" />
              </div>
              <div>
                <p className="text-xs text-gray-200 uppercase tracking-wider font-semibold">Paid</p>
                <p className="text-xl font-bold">{totalPaid}</p>
              </div>
            </div>

            <div className="flex items-center gap-3">
              <div className="bg-red-500/30 p-2 rounded-full">
                <XCircle size={20} className="text-red-300" />
              </div>
              <div>
                <p className="text-xs text-gray-200 uppercase tracking-wider font-semibold">Unpaid</p>
                <p className="text-xl font-bold">{totalCount - totalPaid}</p>
              </div>
            </div>
          </div>
          
          {/* Progress Bar */}
          <div className="mt-4 w-full bg-black/20 rounded-full h-2.5">
            <div 
              className="bg-green-400 h-2.5 rounded-full transition-all duration-500 ease-out" 
              style={{ width: `${progress}%` }}
            ></div>
          </div>
        </div>

        {/* Controls Section */}
        <div className="p-4 border-b border-gray-100 bg-gray-50 flex flex-col sm:flex-row gap-4 justify-between items-center sticky top-0 z-10 shadow-sm">
          <div className="relative w-full sm:w-72">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={18} />
            <input 
              type="text" 
              placeholder="Find a guest..." 
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
            />
          </div>
          <div className="flex gap-2 w-full sm:w-auto">
            <button 
              onClick={() => markAll(true)}
              className="flex-1 sm:flex-none px-3 py-1.5 text-xs font-medium text-green-700 bg-green-50 hover:bg-green-100 border border-green-200 rounded transition-colors"
            >
              Mark Visible Paid
            </button>
             <button 
              onClick={() => markAll(false)}
              className="flex-1 sm:flex-none px-3 py-1.5 text-xs font-medium text-gray-600 bg-white hover:bg-gray-50 border border-gray-200 rounded transition-colors"
            >
              Reset Visible
            </button>
          </div>
        </div>

        {/* List Section */}
        <div className="overflow-x-auto max-h-[60vh] overflow-y-auto">
          <table className="w-full text-left border-collapse">
            <thead className="bg-gray-50 sticky top-0 z-0">
              <tr>
                <th className="p-4 text-xs font-bold text-gray-500 uppercase tracking-wider border-b w-16 text-center">#</th>
                <th className="p-4 text-xs font-bold text-gray-500 uppercase tracking-wider border-b">Guest Name</th>
                <th className="p-4 text-xs font-bold text-gray-500 uppercase tracking-wider border-b text-right">Status</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-100">
              {filteredParticipants.length > 0 ? (
                filteredParticipants.map((p, index) => (
                  <tr 
                    key={p.id} 
                    onClick={() => togglePaid(p.id)}
                    className={`
                      group cursor-pointer transition-colors duration-150 hover:bg-gray-50
                      ${p.paid ? 'bg-green-50/30' : ''}
                    `}
                  >
                    <td className="p-4 text-gray-400 text-sm font-mono text-center">{index + 1}</td>
                    <td className="p-4">
                      <div className={`font-medium ${p.paid ? 'text-green-800' : 'text-gray-700'}`}>
                        {p.name}
                      </div>
                    </td>
                    <td className="p-4 text-right">
                      <div className="flex items-center justify-end gap-3">
                        <span className={`
                          text-xs font-bold px-2 py-1 rounded-full
                          ${p.paid 
                            ? 'bg-green-100 text-green-700 border border-green-200' 
                            : 'bg-red-50 text-red-600 border border-red-100'}
                        `}>
                          {p.paid ? 'PAID' : 'UNPAID'}
                        </span>
                        <div className={`
                          w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all
                          ${p.paid 
                            ? 'bg-green-500 border-green-500' 
                            : 'bg-white border-gray-300 group-hover:border-green-400'}
                        `}>
                          {p.paid && <CheckCircle size={14} className="text-white" />}
                        </div>
                      </div>
                    </td>
                  </tr>
                ))
              ) : (
                <tr>
                  <td colSpan="3" className="p-8 text-center text-gray-500">
                    No guests found matching "{searchTerm}"
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
        
        <div className="bg-gray-50 p-3 text-center text-xs text-gray-400 border-t">
          Use the toggle buttons to update payment status. Data resets on page reload.
        </div>
      </div>
    </div>
  );
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEC Christmas Party Payment Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- FIREBASE SDKs (Required for syncing) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .setup-guide {
            background-color: #fff;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-50">

    <div id="root"></div>

    <script type="text/babel">
        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        // 1. Go to console.firebase.google.com
        // 2. Create a project -> Add Web App (</>) -> Copy config
        // 3. Go to "Build" -> "Firestore Database" -> "Create Database" -> "Start in Test Mode"
        // 4. Paste the config below:
        const firebaseConfig = {
           apiKey: "AIzaSyCa0fXdn9G4pKLGU7ZfQjjO1MizhaXUPZo",
          authDomain: "cec-party.firebaseapp.com",
          projectId: "cec-party",
          storageBucket: "cec-party.firebasestorage.app",
          messagingSenderId: "257743233938",
          appId: "1:257743233938:web:f38d4a0409e987f30bd74b",
          measurementId: "G-CNH0NVN1MJ"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            try {
                firebase.initializeApp(firebaseConfig);
            } catch (e) {
                console.error("Firebase init error:", e);
            }
        }
        
        // Safe database reference initialization
        let db = null;
        let docRef = null;
        try {
            db = firebase.firestore();
            docRef = db.collection("events").doc("cec_christmas_party");
        } catch (e) {
            console.warn("Firestore could not be initialized yet (likely due to missing config).");
        }

        // --- ICONS ---
        const IconDownload = ({ size = 20 }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>);
        const IconCheckCircle = ({ size = 20, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>);
        const IconXCircle = ({ size = 20, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="15" x2="9" y1="9" y2="15"/><line x1="9" x2="15" y1="9" y2="15"/></svg>);
        const IconSearch = ({ size = 20 }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></svg>);
        const IconUsers = ({ size = 20, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>);
        const IconCloud = ({ size = 20 }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>);
        const IconAlert = ({ size = 20 }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-amber-600"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>);

        // --- APP LOGIC ---

        const rawList = [
          "Clarabelle Dejanio", "Jocelyn Monton", "Ken Chua", "Kent Jacob", "Erica Yed Tumulak",
          "Ysa Tepait", "Samuel Colimbo", "Corrine Carmelle", "Ericka Salas", "Myka Marigomen",
          "Princess Mendiola", "Beverly Montebon", "Arianne Marquez", "Deion Alfred Encarguez", "Derek Punes",
          "Carmela Tio Go", "Eunice Pangilinan", "Bianca LapiÃ±a", "Reevey Ilao Gonzales", "Hezekiah MondoÃ±edo",
          "Charles Benedict Tecson Origenes", "Leigh T. Heyrana", "John Russel Jandonero", "Paul Mangubat", "Vince Nathan Mataragnon",
          "Zach Jullian Atupan", "Dave Unabia", "Mikay Ponce", "MC Lawrence", "Jethro Ismael Pamisa Tamala",
          "Margarethe Allanaraiz", "Clark Calacar", "Arianna Ruth Gabunada", "Jon Gil Azcarraga Ramas", "Sophia Abyy",
          "Ma Alexie Aguilar", "Jacob Malazarte", "Maverick Gabrielle", "Amiel Zachary Embrace", "Jamboy Gonzalo",
          "Ma Kate John Borgonia", "Bea Uy", "Elijah Espadilla", "Isaiah David", "Sophia Nandini",
          "Raymond Tabuelog Magdalan", "Marlon Ociel", "Michael Cebrian", "Ashley Britz Chua", "Adrian James Yap",
          "Silvien Libatan"
        ];

        // Ensure we have a stable ID for everyone based on name
        const initialParticipants = rawList.map((name, index) => ({ 
            id: index, 
            name, 
            paid: false 
        }));

        function ConfigScreen() {
            return (
                <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-xl shadow-xl max-w-lg w-full">
                        <div className="flex items-center gap-3 mb-6">
                            <div className="p-3 bg-amber-100 rounded-full">
                                <IconAlert size={32} />
                            </div>
                            <h1 className="text-2xl font-bold text-gray-800">Setup Required</h1>
                        </div>
                        
                        <p className="text-gray-600 mb-6 leading-relaxed">
                            The app is running, but it cannot connect to the cloud because the <b>API Configuration</b> is missing or incorrect.
                        </p>

                        <div className="bg-blue-50 border border-blue-100 p-4 rounded-lg mb-6">
                            <h3 className="font-bold text-blue-900 mb-2 text-sm uppercase">How to fix this:</h3>
                            <ol className="list-decimal pl-5 space-y-2 text-sm text-blue-800">
                                <li>Open this file (index.html) in a text editor (Notepad, VS Code, etc).</li>
                                <li>Find the <code>const firebaseConfig</code> section near the top.</li>
                                <li>Replace the placeholder values with your real Firebase Project Config.</li>
                                <li>Make sure you enabled <b>Firestore Database</b> in "Test Mode" in the Firebase Console.</li>
                            </ol>
                        </div>

                        <button onClick={() => window.location.reload()} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                            I updated the code, Reload now
                        </button>
                    </div>
                </div>
            );
        }

        function App() {
          const [participants, setParticipants] = React.useState([]);
          const [searchTerm, setSearchTerm] = React.useState("");
          const [loading, setLoading] = React.useState(true);
          const [error, setError] = React.useState(null);

          // Check if config is still default
          const isConfigured = firebaseConfig.projectId !== "your-project-id" && !firebaseConfig.apiKey.includes("PASTE");

          if (!isConfigured) {
              return <ConfigScreen />;
          }

          // 1. LISTEN TO DATABASE
          React.useEffect(() => {
            if (!docRef) return; 

            const unsubscribe = docRef.onSnapshot((doc) => {
                if (doc.exists) {
                    // Database has data, load it
                    setParticipants(doc.data().guests);
                    setLoading(false);
                } else {
                    // Database is empty (first run), initialize it
                    docRef.set({ guests: initialParticipants })
                        .then(() => console.log("Database initialized"))
                        .catch(err => {
                            console.error("Set Error:", err);
                            setError(err.message);
                            setLoading(false);
                        });
                }
            }, (err) => {
                console.error("Sync error:", err);
                // Handle the specific "permission-denied" or "not found" error
                if (err.message.includes("permission-denied") || err.code === "permission-denied") {
                    setError("PERMISSION DENIED: Did you create the Database in the Firebase Console? (Build -> Firestore Database -> Create -> Start in Test Mode)");
                } else if (err.message.includes("project-not-found") || err.code === "project-not-found") {
                     setError("PROJECT NOT FOUND: Check your projectId in the config.");
                } else {
                    setError(err.message);
                }
                setLoading(false);
            });

            return () => unsubscribe();
          }, []);

          // 2. UPDATE DATABASE ON CHANGE
          const togglePaid = (id) => {
            // Optimistic update (update UI immediately)
            const updatedList = participants.map(p => 
               p.id === id ? { ...p, paid: !p.paid } : p
            );
            setParticipants(updatedList); // Update UI
            
            // Send to Cloud
            if(docRef) {
                docRef.update({ guests: updatedList }).catch(err => {
                    alert("Error saving: " + err.message);
                });
            }
          };

          const markAll = (status) => {
             if (confirm(`Mark filtered users as ${status ? 'PAID' : 'UNPAID'}? This saves to the cloud immediately.`)) {
                const updatedList = participants.map(p => {
                    if (p.name.toLowerCase().includes(searchTerm.toLowerCase())) {
                        return { ...p, paid: status };
                    }
                    return p;
                });
                setParticipants(updatedList);
                if(docRef) docRef.update({ guests: updatedList });
             }
          };

          const exportToCSV = () => {
            const headers = ["Name", "Payment Status"];
            const rows = participants.map(p => [`"${p.name}"`, p.paid ? "Paid" : "Not Paid"]);
            const csvContent = [headers.join(","), ...rows.map(row => row.join(","))].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "CEC_Christmas_Party_Payments.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          };

          // Filter logic
          const filteredParticipants = participants.filter(p => 
            p.name.toLowerCase().includes(searchTerm.toLowerCase())
          );
          
          const totalPaid = participants.filter(p => p.paid).length;
          const totalCount = participants.length;
          const progress = totalCount > 0 ? (totalPaid / totalCount) * 100 : 0;

          if (loading) return <div className="h-screen flex items-center justify-center text-gray-500 font-medium">Connecting to Cloud...</div>;
          
          if (error) return (
            <div className="min-h-screen flex flex-col items-center justify-center bg-red-50 p-6 text-center">
                <div className="bg-white p-8 rounded-xl shadow-lg border-2 border-red-100 max-w-lg">
                    <div className="text-red-500 mb-4 flex justify-center"><IconAlert size={48} /></div>
                    <h2 className="text-xl font-bold text-red-700 mb-2">Connection Error</h2>
                    <p className="text-gray-700 mb-4 font-mono text-sm bg-gray-100 p-3 rounded text-left break-words">{error}</p>
                    <p className="text-sm text-gray-500">Double check that you selected <b>"Start in Test Mode"</b> when creating the database in the Firebase Console.</p>
                </div>
            </div>
          );

          return (
            <div className="min-h-screen p-4 sm:p-8 font-sans text-gray-800">
              <div className="max-w-4xl mx-auto bg-white shadow-xl rounded-xl overflow-hidden border border-gray-100">
                
                {/* Header Section */}
                <div className="bg-gradient-to-r from-red-600 to-green-700 p-6 text-white">
                  <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                      <h1 className="text-2xl md:text-3xl font-bold flex items-center gap-2">
                        ðŸŽ„ CEC Christmas Party
                      </h1>
                      <div className="flex items-center gap-2 text-red-100 mt-1 opacity-90 text-sm">
                         <IconCloud size={16} /> 
                         <span>Live Cloud Sync Active</span>
                      </div>
                    </div>
                    <button onClick={exportToCSV} className="bg-white text-green-700 hover:bg-gray-100 px-4 py-2 rounded-lg font-semibold shadow-sm flex items-center gap-2 transition-all active:scale-95">
                      <IconDownload size={18} /> Export
                    </button>
                  </div>

                  {/* Stats Bar */}
                  <div className="mt-6 bg-black/20 rounded-lg p-4 flex flex-wrap gap-6 items-center">
                    <div className="flex items-center gap-3">
                      <div className="bg-white/20 p-2 rounded-full"><IconUsers size={20} className="text-white" /></div>
                      <div><p className="text-xs text-gray-200 uppercase tracking-wider font-semibold">Guests</p><p className="text-xl font-bold">{totalCount}</p></div>
                    </div>
                    <div className="flex items-center gap-3">
                      <div className="bg-green-500/30 p-2 rounded-full"><IconCheckCircle size={20} className="text-green-300" /></div>
                      <div><p className="text-xs text-gray-200 uppercase tracking-wider font-semibold">Paid</p><p className="text-xl font-bold">{totalPaid}</p></div>
                    </div>
                    <div className="flex items-center gap-3">
                      <div className="bg-red-500/30 p-2 rounded-full"><IconXCircle size={20} className="text-red-300" /></div>
                      <div><p className="text-xs text-gray-200 uppercase tracking-wider font-semibold">Unpaid</p><p className="text-xl font-bold">{totalCount - totalPaid}</p></div>
                    </div>
                  </div>
                  
                  {/* Progress Bar */}
                  <div className="mt-4 w-full bg-black/20 rounded-full h-2.5">
                    <div className="bg-green-400 h-2.5 rounded-full transition-all duration-500 ease-out" style={{ width: `${progress}%` }}></div>
                  </div>
                </div>

                {/* Controls Section */}
                <div className="p-4 border-b border-gray-100 bg-gray-50 flex flex-col sm:flex-row gap-4 justify-between items-center sticky top-0 z-10 shadow-sm">
                  <div className="relative w-full sm:w-72">
                    <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"><IconSearch size={18} /></div>
                    <input type="text" placeholder="Find a guest..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" />
                  </div>
                  <div className="flex gap-2 w-full sm:w-auto">
                    <button onClick={() => markAll(true)} className="flex-1 sm:flex-none px-3 py-1.5 text-xs font-medium text-green-700 bg-green-50 hover:bg-green-100 border border-green-200 rounded transition-colors">Mark Visible Paid</button>
                    <button onClick={() => markAll(false)} className="flex-1 sm:flex-none px-3 py-1.5 text-xs font-medium text-gray-600 bg-white hover:bg-gray-50 border border-gray-200 rounded transition-colors">Reset Visible</button>
                  </div>
                </div>

                {/* List Section */}
                <div className="overflow-x-auto max-h-[60vh] overflow-y-auto">
                  <table className="w-full text-left border-collapse">
                    <thead className="bg-gray-50 sticky top-0 z-0">
                      <tr>
                        <th className="p-4 text-xs font-bold text-gray-500 uppercase tracking-wider border-b w-16 text-center">#</th>
                        <th className="p-4 text-xs font-bold text-gray-500 uppercase tracking-wider border-b">Guest Name</th>
                        <th className="p-4 text-xs font-bold text-gray-500 uppercase tracking-wider border-b text-right">Status</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                      {filteredParticipants.length > 0 ? (
                        filteredParticipants.map((p, index) => (
                          <tr key={p.id} onClick={() => togglePaid(p.id)} className={`group cursor-pointer transition-colors duration-150 hover:bg-gray-50 ${p.paid ? 'bg-green-50/30' : ''}`}>
                            <td className="p-4 text-gray-400 text-sm font-mono text-center">{index + 1}</td>
                            <td className="p-4"><div className={`font-medium ${p.paid ? 'text-green-800' : 'text-gray-700'}`}>{p.name}</div></td>
                            <td className="p-4 text-right">
                              <div className="flex items-center justify-end gap-3">
                                <span className={`text-xs font-bold px-2 py-1 rounded-full ${p.paid ? 'bg-green-100 text-green-700 border border-green-200' : 'bg-red-50 text-red-600 border border-red-100'}`}>{p.paid ? 'PAID' : 'UNPAID'}</span>
                                <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${p.paid ? 'bg-green-500 border-green-500' : 'bg-white border-gray-300 group-hover:border-green-400'}`}>
                                  {p.paid && <IconCheckCircle size={14} className="text-white" />}
                                </div>
                              </div>
                            </td>
                          </tr>
                        ))
                      ) : (
                        <tr><td colSpan="3" className="p-8 text-center text-gray-500">No guests found matching "{searchTerm}"</td></tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
